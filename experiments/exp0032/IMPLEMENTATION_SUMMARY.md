# exp0032: Highå°‚é–€å®¶å¼·åŒ–ç‰ˆMoE å®Ÿè£…ã‚µãƒãƒªãƒ¼

## ğŸ“‹ å®Ÿè£…å®Œäº†å†…å®¹

### âœ… å®Ÿè£…ã—ãŸæ”¹å–„

#### 1. **å¯¾æ•°å¤‰æ›ã«ã‚ˆã‚‹å­¦ç¿’å®‰å®šåŒ–**
```python
# Highé ˜åŸŸã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å¯¾æ•°å¤‰æ›
y_tr_high_log = np.log1p(y_tr_high)
y_val_high_log = np.log1p(y_val_high)

# äºˆæ¸¬æ™‚ã«é€†å¤‰æ›
high_oof_preds_log = high_model.predict(X_val_high)
high_oof_preds[val_mask] = np.expm1(high_oof_preds_log)
```

**åŠ¹æœ**:
- è£¾ã®é•·ã„åˆ†å¸ƒã‚’åœ§ç¸®ã—ã€å¤–ã‚Œå€¤ã®å½±éŸ¿ã‚’è»½æ¸›
- å­¦ç¿’ã®å®‰å®šæ€§ãŒå‘ä¸Š
- exp0010ã§å­¦ç¿’xTãŒåŠ¹æœçš„ã ã£ãŸã®ã¨åŒã˜åŸç†

#### 2. **æ­£å‰‡åŒ–ã®å¼·åŒ–**
```python
high_params = {
    'min_child_samples': 50,  # 30 â†’ 50ï¼ˆéå­¦ç¿’æŠ‘åˆ¶ï¼‰
    'reg_alpha': 0.1,  # L1æ­£å‰‡åŒ–è¿½åŠ 
    'reg_lambda': 1.0,  # L2æ­£å‰‡åŒ–å¼·åŒ–
    # ... ãã®ä»–ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
}
```

**åŠ¹æœ**:
- Highé ˜åŸŸã¯ã‚µãƒ³ãƒ—ãƒ«æ•°ãŒå°‘ãªã„ï¼ˆç´„30%ï¼‰ãŸã‚éå­¦ç¿’ã—ã‚„ã™ã„
- æ­£å‰‡åŒ–ã«ã‚ˆã‚Šæ±åŒ–æ€§èƒ½ãŒå‘ä¸Š

### ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„

#### exp0031ã‹ã‚‰ã®æ”¹å–„ç›®æ¨™
| æŒ‡æ¨™ | exp0031 | exp0032ç›®æ¨™ | æ”¹å–„å¹… |
|------|---------|-------------|--------|
| Highå°‚é–€å®¶ wRMSE | 0.392 | 0.25 | -0.142 |
| MoEå…¨ä½“ OOF | 0.2271 | 0.225 | -0.002 |

#### æ”¹å–„ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 
1. **å¯¾æ•°å¤‰æ›**: Highé ˜åŸŸã®äºˆæ¸¬ç²¾åº¦ãŒå‘ä¸Š
2. **æ­£å‰‡åŒ–**: éå­¦ç¿’ã‚’æŠ‘åˆ¶ã—ã€CV/OOFã®ä¹–é›¢ã‚’å‰Šæ¸›
3. **MoEåŠ¹æœ**: Highå°‚é–€å®¶ã®æ”¹å–„ãŒMoEå…¨ä½“ã«æ³¢åŠ

## ğŸ”§ ä¿®æ­£ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«

### ä¸»è¦ãªå¤‰æ›´
- `experiments/exp0032/training_with_nnls.ipynb`
  - Step 4: Highå°‚é–€å®¶ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¯¾æ•°å¤‰æ›ç‰ˆã«ç½®ãæ›ãˆ
  - Step 6: ãƒ¡ãƒˆãƒªã‚¯ã‚¹ä¿å­˜éƒ¨åˆ†ã‚’ exp0032 ç”¨ã«æ›´æ–°
  - Step 7: æå‡ºãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ›´æ–°

### æˆæœç‰©ã®å‘½å
- ãƒ¡ãƒˆãƒªã‚¯ã‚¹: `logs/host_moe_high_opt_003_metrics.json`
- OOFè©³ç´°: `artifacts/oof_predictions_moe_high_opt.csv`
- æå‡ºãƒ•ã‚¡ã‚¤ãƒ«: `submissions/host_moe_high_opt_003_submission.csv`

## ğŸš€ å®Ÿè¡Œæ‰‹é †

### 1. Jupyter Notebookã§å®Ÿè¡Œ
```bash
cd /Users/aritakohei/DSDOJO-3/experiments/exp0032
jupyter lab training_with_nnls.ipynb
```

### 2. å®Ÿè¡Œã™ã‚‹ã‚»ãƒ«
- **æ—¢å­˜ã‚»ãƒ«ï¼ˆã€œ65ï¼‰**: exp0031ã¨åŒã˜ãã€ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã€œNNLSçµ±åˆã¾ã§å®Ÿè¡Œ
- **ã‚»ãƒ«74**: Isotonicæ ¡æ­£ã‚»ãƒ«ã‚’å®Ÿè¡Œï¼ˆ`calibrated_oof_preds`ã‚’å®šç¾©ï¼‰
- **MoEã‚»ãƒ«ï¼ˆ66ã€œ73ï¼‰**: ã‚²ãƒ¼ãƒˆåˆ†é¡å™¨ã€Low/Highå°‚é–€å®¶ã€MoEåˆæˆã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ä¿å­˜

### 3. å®Ÿè¡Œé †åºã®æ³¨æ„ç‚¹
âš ï¸ **é‡è¦**: ã‚»ãƒ«74ï¼ˆIsotonicæ ¡æ­£ï¼‰ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ã€ã‚»ãƒ«72ï¼ˆStep 6ï¼‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

ç†ç”±: Step 6ã§`calibrated_oof_preds`ã‚’ä½¿ç”¨ã—ã¾ã™ãŒã€ã“ã‚Œã¯ã‚»ãƒ«74ã§å®šç¾©ã•ã‚Œã¾ã™ã€‚
â†’ `try-except`ã§å¯¾å¿œæ¸ˆã¿ãªã®ã§ã€ã‚¨ãƒ©ãƒ¼ã¯å‡ºã¾ã›ã‚“ãŒã€æ­£ã—ã„ã‚¹ã‚³ã‚¢ã‚’å¾—ã‚‹ã«ã¯é †åºãŒé‡è¦ã§ã™ã€‚

## ğŸ“ˆ æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ

å®Ÿè¡Œå¾Œã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

### Highå°‚é–€å®¶ã®æ”¹å–„
- [ ] Foldåˆ¥ã®wRMSEãŒexp0031ã‚ˆã‚Šæ”¹å–„ã—ã¦ã„ã‚‹ã‹
- [ ] å¯¾æ•°å¤‰æ›å¾Œã®åˆ†å¸ƒçµ±è¨ˆãŒé©åˆ‡ã‹ï¼ˆå¹³å‡ãƒ»æ¨™æº–åå·®ï¼‰
- [ ] é€†å¤‰æ›å¾Œã®äºˆæ¸¬å€¤ãŒå¦¥å½“ãªç¯„å›²ã‹ï¼ˆéè² ã€ä¸Šé™ãƒã‚§ãƒƒã‚¯ï¼‰

### MoEå…¨ä½“ã®æ”¹å–„
- [ ] MoE OOF wRMSEãŒexp0031ï¼ˆ0.2271ï¼‰ã‚ˆã‚Šæ”¹å–„ã—ã¦ã„ã‚‹ã‹
- [ ] æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿Ï„ã®æœ€é©å€¤ãŒå¤‰åŒ–ã—ã¦ã„ã‚‹ã‹
- [ ] ã‚²ãƒ¼ãƒˆåˆ†é›¢ç²¾åº¦ï¼ˆAUC/APï¼‰ãŒç¶­æŒã•ã‚Œã¦ã„ã‚‹ã‹

### äºˆæ¸¬ã®å¥å…¨æ€§
- [ ] OOFäºˆæ¸¬ã®åˆ†å¸ƒãŒè¨“ç·´ãƒ‡ãƒ¼ã‚¿ã¨é¡ä¼¼ã—ã¦ã„ã‚‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆäºˆæ¸¬ã®çµ±è¨ˆé‡ãŒå¦¥å½“ã‹
- [ ] è² ã®äºˆæ¸¬å€¤ãŒã‚¯ãƒªãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã‹

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

#### 1. `calibrated_oof_preds`ãŒæœªå®šç¾©ã‚¨ãƒ©ãƒ¼
**åŸå› **: ã‚»ãƒ«74ã‚ˆã‚Šå‰ã«ã‚»ãƒ«72ã‚’å®Ÿè¡Œã—ãŸ
**è§£æ±ºç­–**: ã‚»ãƒ«74ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ã€ã‚»ãƒ«72ã‚’å†å®Ÿè¡Œ

#### 2. å¯¾æ•°å¤‰æ›ã§NaN/Inf
**åŸå› **: è² ã®å€¤ã«å¯¾ã—ã¦log1pã‚’é©ç”¨ã—ãŸ
**è§£æ±ºç­–**: Highé ˜åŸŸã®ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆ`high_mask = y >= 0.1`ï¼‰ãŒæ­£ã—ã„ã‹ç¢ºèª

#### 3. Highå°‚é–€å®¶ã®ã‚¹ã‚³ã‚¢ãŒæ‚ªåŒ–
**åŸå› **: æ­£å‰‡åŒ–ãŒå¼·ã™ãã‚‹ã€ã¾ãŸã¯å¯¾æ•°å¤‰æ›ãŒä¸é©åˆ‡
**è§£æ±ºç­–**:
- æ­£å‰‡åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ï¼ˆ`reg_alpha`, `reg_lambda`ã‚’æ¸›ã‚‰ã™ï¼‰
- å¯¾æ•°å¤‰æ›ã‚’ç„¡åŠ¹åŒ–ã—ã¦ç¢ºèª

## ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—å€™è£œ

### ã•ã‚‰ãªã‚‹æ”¹å–„æ¡ˆï¼ˆå„ªå…ˆåº¦é †ï¼‰

#### A. Optunaæœ€é©åŒ–ã®è¿½åŠ 
```python
# Highå°‚é–€å®¶å°‚ç”¨ã®Optunaæœ€é©åŒ–
def objective_high(trial):
    params = {
        'num_leaves': trial.suggest_int('num_leaves', 10, 50),
        'learning_rate': trial.suggest_float('learning_rate', 0.01, 0.1),
        'min_child_samples': trial.suggest_int('min_child_samples', 30, 100),
        'reg_alpha': trial.suggest_float('reg_alpha', 0.0, 1.0),
        'reg_lambda': trial.suggest_float('reg_lambda', 0.0, 2.0),
    }
    # ... Highé ˜åŸŸã§å­¦ç¿’ãƒ»è©•ä¾¡
    return cv_score
```

#### B. 3å°‚é–€å®¶MoE
- Lowï¼ˆy < 0.05ï¼‰ã€Midï¼ˆ0.05 â‰¤ y < 0.2ï¼‰ã€Highï¼ˆy â‰¥ 0.2ï¼‰ã«åˆ†å‰²
- 2æ®µéšã‚²ãƒ¼ãƒˆæ©Ÿæ§‹ã®å°å…¥

#### C. CatBoost Highå°‚é–€å®¶
- LightGBMã¨CatBoostã®ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«
- Highé ˜åŸŸã§ã®å¤šæ§˜æ€§å‘ä¸Š

## ğŸ“ å®Ÿé¨“ãƒãƒ¼ãƒˆ

### ä½œæ¥­å±¥æ­´
- 2025-10-05: exp0032ä½œæˆã€Highå°‚é–€å®¶ã®å¯¾æ•°å¤‰æ›ãƒ»æ­£å‰‡åŒ–å¼·åŒ–ã‚’å®Ÿè£…
- ã‚»ãƒ«é †åºã®æ¤œè¨¼å®Œäº†ï¼ˆã‚»ãƒ«74 â†’ ã‚»ãƒ«72ã®é †ã§å®Ÿè¡Œï¼‰
- README.md, IMPLEMENTATION_SUMMARY.mdä½œæˆ

### æ¬¡å›å®Ÿè¡Œæ™‚ã®ãƒ¡ãƒ¢
- [ ] Highå°‚é–€å®¶ã®Optunaæœ€é©åŒ–ã‚’è¿½åŠ ï¼ˆexp0033å€™è£œï¼‰
- [ ] Lowå°‚é–€å®¶ã‚‚åŒæ§˜ã«æœ€é©åŒ–ï¼ˆå¯¾æ•°å¤‰æ›ã¯ä¸è¦ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰
- [ ] æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿Ï„ã®æ¢ç´¢ç¯„å›²ã‚’æ‹¡å¤§

---

**ä½œæˆæ—¥**: 2025-10-05
**å®Ÿé¨“ID**: exp0032
**ãƒ™ãƒ¼ã‚¹**: exp0031ï¼ˆæœ¨ãƒ¢ãƒ‡ãƒ«ç‰ˆMoEï¼‰
**æ”¹å–„å†…å®¹**: Highå°‚é–€å®¶ã®å¯¾æ•°å¤‰æ› + æ­£å‰‡åŒ–å¼·åŒ–
