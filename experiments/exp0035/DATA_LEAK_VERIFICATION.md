# データリーク検証レポート (攻撃テンポ+視野・認知特徴量)

## ✅ 検証結果: リークなし

### 攻撃テンポ特徴量 (5列)

#### 1. `possession_duration_before_shot`
- **使用情報**: GCAアクション時の「直前」ポゼッション時間
- **計算**: `prev_team`(1つ前のチーム) == 現在のチーム の場合の時間差
- **リーク判定**: ✅ なし（過去情報のみ）

#### 2. `pass_tempo_variance`
- **使用情報**: パス間隔の分散
- **計算**: 同一チーム内の次パス時間 - 現在時間（チーム内で`shift(-1)`）
- **リーク判定**: ✅ なし（チーム単位集計、選手個人の将来情報不使用）

#### 3. `acceleration_phase_count`
- **使用情報**: 連続3パスの時間間隔
- **計算**: interval_1 > interval_2 > interval_3 の判定
- **リーク判定**: ✅ なし（チーム単位のパス連鎖、選手個人の将来情報不使用）

#### 4. `quick_transition_rate`
- **使用情報**: ターンオーバー（チーム切り替わり）後5秒以内のGCA
- **計算**: `prev_team != team` のタイミングから5秒以内
- **リーク判定**: ✅ なし（過去のターンオーバー情報のみ）

#### 5. `slow_buildup_gca_rate`
- **使用情報**: 15秒以上ポゼッション後のGCA
- **計算**: `possession_time >= 15.0` の判定
- **リーク判定**: ✅ なし（過去のポゼッション時間のみ）

### 視野・認知特徴量 (4列)

#### 1. `switch_play_gca`
- **使用情報**: 横移動40m以上のパス + GCA判定
- **計算**: `|end_y - start_y| >= 40` & GCA
- **リーク判定**: ✅ なし（現在アクションの座標のみ）

#### 2. `blind_side_pass_count`
- **使用情報**: 前進10m+ & 横移動/前進比<0.5
- **計算**: 現在アクションの座標から角度計算
- **リーク判定**: ✅ なし（現在アクションのみ）

#### 3. `cross_field_progression`
- **使用情報**: 横+縦同時10m以上
- **計算**: 横移動 & 前進移動の同時判定
- **リーク判定**: ✅ なし（現在アクションのみ）

#### 4. `vision_angle_wide_pass`
- **使用情報**: パス角度120度以上
- **計算**: `arctan2(dy, dx)` で角度算出
- **リーク判定**: ✅ なし（現在アクションのみ）

## 🔍 GCA判定の安全性

### 使用パターン
```python
# 次2手の情報取得（将来情報）
sa["next_type"] = sa.groupby(match_col)[type_col].shift(-1)
sa["next2_type"] = sa.groupby(match_col)[type_col].shift(-2)

# GCA判定
is_gca = (
    (sa["next_type"].isin(SHOT_TYPES) & (sa["next_team"] == sa[team_col])) |
    (sa["next2_type"].isin(SHOT_TYPES) & (sa["next2_team"] == sa[team_col]))
)
```

### 安全性の根拠
1. **定義として正当**: GCA = 「次2手でシュートにつながるアクション」
2. **テストデータ適用可能**: 同一ロジックでテストにも適用可能
3. **予測対象と独立**: GCAは「チャンス創出能力」の指標であり、xAG（ゴール期待値）とは別の概念
4. **既存実装と一致**: 先行実装のGCA特徴量と同一の判定ロジック

## ⚠️ 注意事項

### チーム単位の将来情報
- `pass_tempo_variance`, `acceleration_phase_count`: チーム単位で次パス時間を使用
- **判定**: 許容範囲（チーム全体のリズム評価であり、選手個人の将来パフォーマンスは不使用）

### ポゼッション時間
- `possession_duration_before_shot`: 「直前」のポゼッション時間を評価
- **判定**: 安全（過去情報のみ、シュート後の情報は不使用）

## ✅ 結論

**全9特徴量**: データリークなし

- 攻撃テンポ特徴量(5列): 全て過去またはチーム単位の情報のみ使用
- 視野・認知特徴量(4列): 全て現在アクションの座標情報のみ使用
- GCA判定: 定義として正当、テストデータにも同一ロジック適用可能

**実装承認**: 安全に使用可能
